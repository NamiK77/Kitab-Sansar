 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookmarks - Kitab Sansar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary: #ff6b6b;
            --secondary: #4ecdc4;
            --dark: #1a2a3a;
            --light: #f7f7f7;
            --accent: #ffd166;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light);
            color: #333;
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--dark) 0%, #2c3e50 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 12px 0;
            width: 100%;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--accent) !important;
        }
        
        .navbar-nav .nav-link {
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }
        
        .navbar-nav .nav-link:hover {
            color: var(--accent) !important;
        }
        
        .navbar-nav .nav-link.active {
            color: var(--accent) !important;
            border-bottom: 2px solid var(--accent);
        }
        
        .bookmarks-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .bookmarks-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .bookmark-item {
            padding: 20px 0;
            border-bottom: 1px solid #eee;
            position: relative;
        }
        
        .bookmark-item:last-child {
            border-bottom: none;
        }
        
        .book-cover {
            max-width: 120px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 5px;
            transition: transform 0.3s ease;
        }
        
        .book-cover:hover {
            transform: scale(1.05);
        }
        
        .book-title {
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .book-author {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .book-price {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        
        .book-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-remove {
            color: var(--primary);
            background-color: rgba(255, 107, 107, 0.1);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-remove:hover {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-view {
            color: var(--dark);
            background-color: var(--accent);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-view:hover {
            background-color: #e6bc5c;
            transform: translateY(-2px);
        }
        
        .empty-bookmarks {
            text-align: center;
            padding: 50px 0;
        }
        
        .empty-bookmarks i {
            font-size: 4rem;
            color: #ccc;
            margin-bottom: 20px;
        }
        
        footer {
            background: linear-gradient(135deg, var(--dark) 0%, #2c3e50 100%);
            color: white;
            padding: 50px 0 20px;
            margin-top: 50px;
        }
        
        footer h5 {
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--accent);
        }
        
        footer a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        footer a:hover {
            color: var(--accent);
            text-decoration: none;
        }
        
        footer ul li {
            margin-bottom: 10px;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: rgba(26, 42, 58, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .toast.show {
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .bookmark-item {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .book-info {
                margin-top: 15px;
                width: 100%;
            }
            
            .book-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="home.html">
                <i class="bi bi-book me-2"></i>Kitab Sansar
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="home.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Categories</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">New Arrivals</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Best Sellers</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <a href="cart.html" class="btn btn-outline-light me-3 position-relative">
                        <i class="bi bi-cart"></i>
                        <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger hidden">0</span>
                    </a>
                    <a href="bookmarks.html" class="btn btn-outline-light me-3 position-relative active">
                        <i class="bi bi-bookmark"></i>
                        <span id="bookmark-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger hidden">0</span>
                    </a>
                    <a href="Login.html" class="btn btn-outline-light me-2">Login</a>
                    <a href="Register.html" class="btn btn-light">Register</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row">
            <div class="col-12">
                <div class="bookmarks-container">
                    <div class="bookmarks-header">
                        <h2 class="mb-0">My Bookmarks</h2>
                        <button id="clear-all" class="btn btn-outline-danger">Clear All</button>
                    </div>
                    
                    <div id="bookmarks-list">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading bookmarks...</span>
                            </div>
                            <p class="mt-2">Loading your bookmarks...</p>
                        </div>
                    </div>
                    
                    <div id="empty-bookmarks" class="empty-bookmarks d-none">
                        <i class="bi bi-bookmark"></i>
                        <h4>No Bookmarks Yet</h4>
                        <p class="text-muted">Browse books and click the bookmark icon to add them to your bookmarks.</p>
                        <a href="home.html" class="btn btn-primary mt-3">Browse Books</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-4 mb-md-0">
                    <h5>Kitab Sansar</h5>
                    <p>Your one-stop destination for all your reading needs. Discover books from various genres and authors.</p>
                </div>
                <div class="col-md-2 mb-4 mb-md-0">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="home.html" class="text-white">Home</a></li>
                        <li><a href="#" class="text-white">Books</a></li>
                        <li><a href="#" class="text-white">Categories</a></li>
                        <li><a href="#" class="text-white">About Us</a></li>
                    </ul>
                </div>
                <div class="col-md-3 mb-4 mb-md-0">
                    <h5>Contact Us</h5>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-geo-alt me-2"></i>123 Book Street, Reading City</li>
                        <li><i class="bi bi-envelope me-2"></i>info@kitabsansar.com</li>
                        <li><i class="bi bi-telephone me-2"></i>+1 234 567 8900</li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Subscribe</h5>
                    <p>Subscribe to our newsletter for updates on new arrivals and special offers.</p>
                    <div class="input-group mb-3">
                        <input type="email" class="form-control" placeholder="Your Email">
                        <button class="btn btn-primary" type="button">Subscribe</button>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12 text-center">
                    <p class="mb-0">© 2023 Kitab Sansar. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const user = localStorage.getItem('user');
            if (user) {
                const authButtons = document.querySelector('.d-flex');
                authButtons.innerHTML = `
                    <a href="cart.html" class="btn btn-outline-light me-3 position-relative">
                        <i class="bi bi-cart"></i>
                        <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger hidden">0</span>
                    </a>
                    <a href="bookmarks.html" class="btn btn-outline-light me-3 position-relative active">
                        <i class="bi bi-bookmark"></i>
                        <span id="bookmark-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger hidden">0</span>
                    </a>
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i> ${JSON.parse(user).username}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i>Profile</a></li>
                            <li><a class="dropdown-item" href="orders.html"><i class="bi bi-bag me-2"></i>My Orders</a></li>
                            <li><a class="dropdown-item" href="bookmarks.html"><i class="bi bi-bookmark me-2"></i>Wishlist</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                `;
                
                loadBookmarks();
                updateCartCount();
                updateBookmarkCount();
            } else {
                window.location.href = 'Login.html?redirect=bookmarks.html';
            }

            document.getElementById('clear-all').addEventListener('click', clearAllBookmarks);
        });

        async function loadBookmarks() {
            try {
                const response = await fetch('/api/bookmark', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                if (!response.ok) throw new Error('Failed to fetch bookmarks');

                const bookmarks = await response.json();
                const bookmarksList = document.getElementById('bookmarks-list');
                const emptyBookmarks = document.getElementById('empty-bookmarks');
                const bookmarkCountElement = document.getElementById('bookmark-count');

                bookmarkCountElement.textContent = bookmarks.length;
                if (bookmarks.length > 0) {
                    bookmarkCountElement.classList.remove('hidden');
                } else {
                    bookmarkCountElement.classList.add('hidden');
                }

                if (bookmarks.length === 0) {
                    bookmarksList.innerHTML = '';
                    emptyBookmarks.classList.remove('d-none');
                    return;
                }

                emptyBookmarks.classList.add('d-none');
                bookmarksList.innerHTML = '';

                bookmarks.forEach(book => {
                    if (!book || !book.id) {
                        console.warn('Invalid bookmark data:', book);
                        return;
                    }
                    const bookmarkItem = createBookmarkItem(book);
                    bookmarksList.appendChild(bookmarkItem);
                });
            } catch (error) {
                console.error('Error loading bookmarks:', error);
                document.getElementById('bookmarks-list').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Failed to load bookmarks. Please try again later.
                    </div>
                `;
            }
        }

        function createBookmarkItem(book) {
            const item = document.createElement('div');
            item.className = 'bookmark-item';
            const priceDisplay = book.isOnSale ? 
                `<span class="book-price">$${book.discountPrice?.toFixed(2) || 'N/A'}</span>
                 <span class="text-muted text-decoration-line-through">$${book.price?.toFixed(2) || 'N/A'}</span>` : 
                `<span class="book-price">$${book.price?.toFixed(2) || 'N/A'}</span>`;

            item.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-md-2 col-sm-3 mb-3 mb-md-0">
                        <a href="bookdetails.html?id=${book.id}">
                            <img src="${book.coverImageUrl || 'https://via.placeholder.com/120x180?text=No+Image'}" 
                                 alt="${book.title || 'Unknown Title'}" class="img-fluid book-cover">
                        </a>
                    </div>
                    <div class="col-md-7 col-sm-9 book-info">
                        <a href="bookdetails.html?id=${book.id}" class="text-decoration-none">
                            <h5 class="book-title">${book.title || 'Unknown Title'}</h5>
                        </a>
                        <p class="book-author">by ${book.author || 'Unknown Author'}</p>
                        ${priceDisplay}
                        <div class="book-actions">
                            <button class="btn btn-view" onclick="viewBookDetails(${book.id})">
                                View Details
                            </button>
                            <button class="btn btn-remove" onclick="removeBookmark(${book.id})">
                                <i class="bi bi-trash me-1"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            `;
            return item;
        }

        function viewBookDetails(bookId) {
            window.location.href = `Bookdetails.html?id=${bookId}`;
        }

        function removeBookmark(bookId) {
            if (!localStorage.getItem('token')) {
                // Handle removal from localStorage for non-authenticated users
                let bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || [];
                bookmarks = bookmarks.filter(bookmark => bookmark.id != bookId);
                localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
                
                showToast('Book removed from bookmarks');
                loadBookmarks();
                updateBookmarkCount();
                return;
            }

            fetch(`/api/bookmark/${bookId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (response.ok) {
                    showToast('Book removed from bookmarks');
                    loadBookmarks();
                    updateBookmarkCount();
                } else {
                    response.text().then(text => {
                        console.error('Error response:', text);
                        showToast('Failed to remove bookmark: ' + response.status);
                    });
                }
            })
            .catch(error => {
                console.error('Error removing bookmark:', error);
                showToast('An error occurred. Please try again.');
            });
        }

        function updateBookmarkCount() {
            const bookmarkCountElement = document.getElementById('bookmark-count');
            if (!bookmarkCountElement) return;
            
            // If user is logged in, fetch from API
            if (localStorage.getItem('token')) {
                fetch('/api/bookmark/count', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                })
                .then(response => {
                    if (response.ok) return response.json();
                    throw new Error('Failed to fetch bookmark count');
                })
                .then(data => {
                    if (data.count > 0) {
                        bookmarkCountElement.textContent = data.count;
                        bookmarkCountElement.classList.remove('hidden');
                    } else {
                        bookmarkCountElement.classList.add('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error fetching bookmark count:', error);
                    // Fallback to localStorage
                    updateBookmarkCountFromLocalStorage();
                });
            } else {
                // Use localStorage for non-logged in users
                updateBookmarkCountFromLocalStorage();
            }
        }

        function updateBookmarkCountFromLocalStorage() {
            const bookmarkCountElement = document.getElementById('bookmark-count');
            if (!bookmarkCountElement) return;
            
            const bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || [];
            if (bookmarks.length > 0) {
                bookmarkCountElement.textContent = bookmarks.length;
                bookmarkCountElement.classList.remove('hidden');
            } else {
                bookmarkCountElement.classList.add('hidden');
            }
        }
        

        
        async function clearAllBookmarks() {
            try {
                const response = await fetch('/api/bookmark', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                if (!response.ok) throw new Error('Failed to fetch bookmarks');

                const bookmarks = await response.json();
                const deletePromises = bookmarks.map(book =>
                    fetch(`/api/bookmark/${book.id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('token')
                        }
                    })
                );

                const results = await Promise.all(deletePromises);
                if (results.every(res => res.ok)) {
                    showToast('All bookmarks cleared');
                    loadBookmarks();
                    updateBookmarkCount();
                } else {
                    showToast('Failed to clear some bookmarks');
                }
            } catch (error) {
                console.error('Error clearing bookmarks:', error);
                showToast('An error occurred. Please try again.');
            }
        }

        function addToBookmark(bookId, title, author, price, cover) {
            // For logged in users, use API
            if (localStorage.getItem('token')) {
                fetch('/api/bookmark', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify({ bookId: bookId })
                })
                .then(response => {
                    if (response.ok) {
                        showToast('Book added to your bookmarks!');
                        updateBookmarkButton(bookId, true);
                        updateBookmarkCount();
                    } else {
                        showToast('Failed to add book to bookmarks.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('An error occurred. Please try again.');
                });
            } else {
                // For non-logged in users, use localStorage
                let bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || [];
                
                // Check if already bookmarked
                if (!bookmarks.some(b => b.id === bookId)) {
                    bookmarks.push({
                        id: bookId,
                        title: title,
                        author: author,
                        price: price,
                        cover: cover
                    });
                    localStorage.setItem('bookmarks', JSON.stringify(bookmarks));
                    showToast('Book added to your bookmarks!');
                    updateBookmarkButton(bookId, true);
                    updateBookmarkCount();
                }
            }
        }
        
    
        function removeBookmark(bookId) {
            fetch(`/api/bookmark/${bookId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            })
            .then(response => {
                if (response.ok) {
                    showToast('Book removed from bookmarks');
                    loadBookmarks();
                    updateBookmarkCount();
                } else {
                    response.text().then(text => {
                        console.error(`Failed to remove bookmark: Status ${response.status}, ${text}`);
                        showToast(`Failed to remove bookmark (Status: ${response.status})`);
                    });
                }
            })
            .catch(error => {
                console.error('Error removing bookmark:', error);
                showToast('An error occurred. Please try again.');
            });
        }
        
        function toggleBookmark(bookId, title, author, price, cover) {
            // Check if book is already bookmarked
            const isBookmarked = checkIfBookmarked(bookId);
            
            if (isBookmarked) {
                removeFromBookmark(bookId);
            } else {
                addToBookmark(bookId, title, author, price, cover);
            }
        }

        function checkIfBookmarked(bookId) {
            const bookmarks = JSON.parse(localStorage.getItem('bookmarks')) || [];
            return bookmarks.some(b => b.id === bookId);
        }
        
        function updateBookmarkButton(bookId, isBookmarked) {
            const bookmarkBtn = document.querySelector(`.bookmark-btn[data-id="${bookId}"]`);
            if (!bookmarkBtn) return;
            
            if (isBookmarked) {
                bookmarkBtn.classList.add('bookmarked');
                bookmarkBtn.innerHTML = '<i class="bi bi-bookmark-fill"></i>';
            } else {
                bookmarkBtn.classList.remove('bookmarked');
                bookmarkBtn.innerHTML = '<i class="bi bi-bookmark"></i>';
            }
        }
    
        function addToCart(bookId, quantity = 1) {
            if (!localStorage.getItem('user')) {
                showToast('Please login to add books to cart');
                setTimeout(() => {
                    window.location.href = 'Login.html';
                }, 2000);
                return;
            }
            
            fetch(`/api/cart/${bookId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                },
                body: JSON.stringify({ quantity: quantity })
            })
            .then(response => {
                if (response.ok) {
                    showToast('Book added to cart');
                    updateCartCount();
                } else {
                    showToast('Failed to add book to cart');
                }
            })
            .catch(error => {
                console.error('Error adding to cart:', error);
                showToast('An error occurred. Please try again.');
            });
        }

        async function updateCartCount() {
            if (!localStorage.getItem('user')) return;
            
            try {
                const response = await fetch('/api/cart/count', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                if (!response.ok) throw new Error('Failed to fetch cart count');

                const data = await response.json();
                const cartCountElement = document.getElementById('cart-count');
                cartCountElement.textContent = data.count;
                if (data.count > 0) {
                    cartCountElement.classList.remove('hidden');
                } else {
                    cartCountElement.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error updating cart count:', error);
            }
        }

  
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'home.html';
        }
    </script>
</body>
</html> 


