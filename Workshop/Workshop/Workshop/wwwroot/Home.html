<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitab Sansar - Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
        <a class="navbar-brand" href="home.html">
            <i class="bi bi-book me-2"></i>Kitab Sansar
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="home.html">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Categories</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">New Arrivals</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Best Sellers</a>
                </li>
            </ul>
            <div class="d-flex align-items-center">
                <a href="cart.html" class="btn btn-outline-light me-3 position-relative">
                    <i class="bi bi-cart"></i>
                    <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger hidden">0</span>
                </a>
                <a href="bookmarks.html" class="btn btn-outline-light me-3 position-relative">
                    <i class="bi bi-bookmark"></i>
                    <span id="bookmark-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger hidden">0</span>
                </a>
                <a href="Login.html" class="btn btn-outline-light me-2">Login</a>
                <a href="Register.html" class="btn btn-light">Register</a>
            </div>
        </div>
    </div>
</nav>

<!-- Hero Section -->
<section class="hero-section text-center">
    <div class="container">
        <h1 class="display-4 fw-bold">Discover Your Next Favorite Book</h1>
        <p class="lead">Explore our vast collection of books from various genres</p>
        
        <!-- Search Bar -->
        <div class="search-bar">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search by title, author, or ISBN...">
                <button class="btn btn-warning" type="button" id="searchButton">
                    <i class="bi bi-search"></i> Search
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Filter and Sort Section -->
<section class="container filter-section">
    <div class="row g-3">
        <div class="col-md-3">
            <h5>Sort By</h5>
            <select class="form-select form-control-sm" id="sortSelect">
                <option value="none">Default</option>
                <option value="price-asc">Price: Low to High</option>
                <option value="price-desc">Price: High to Low</option>
                <option value="rating-desc">Rating: High to Low</option>
                <option value="title-asc">Title: A-Z</option>
                <option value="title-desc">Title: Z-A</option>
            </select>
        </div>
        <div class="col-md-3">
            <h5>Genres</h5>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="genre-fiction" value="Fiction">
                <label class="form-check-label" for="genre-fiction">Fiction</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="genre-nonfiction" value="Non-Fiction">
                <label class="form-check-label" for="genre-nonfiction">Non-Fiction</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="genre-mystery" value="Mystery">
                <label class="form-check-label" for="genre-mystery">Mystery</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="genre-scifi" value="Science Fiction">
                <label class="form-check-label" for="genre-scifi">Science Fiction</label>
            </div>
        </div>
        <div class="col-md-3">
            <h5>Price Range</h5>
            <div class="input-group input-group-sm mb-2">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" id="minPrice" placeholder="Min" min="0">
            </div>
            <div class="input-group input-group-sm">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" id="maxPrice" placeholder="Max" min="0">
            </div>
        </div>
        <div class="col-md-3">
            <h5>Rating</h5>
            <select class="form-select form-control-sm" id="minRating">
                <option value="0">Any</option>
                <option value="3">3+ Stars</option>
                <option value="4">4+ Stars</option>
                <option value="4.5">4.5+ Stars</option>
            </select>
            <h5 class="mt-3">Format</h5>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="format-hardcover" value="Hardcover">
                <label class="form-check-label" for="format-hardcover">Hardcover</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="format-paperback" value="Paperback">
                <label class="form-check-label" for="format-paperback">Paperback</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="format-ebook" value="eBook">
                <label class="form-check-label" for="format-ebook">eBook</label>
            </div>
        </div>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-3">
        <span id="resultsCount" class="text-muted">0 books found</span>
        <button class="btn btn-outline-primary btn-sm" id="clearFilters">Clear Filters</button>
    </div>
</section>

<!-- Books Section -->
<section class="container mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Featured Books</h2>
        <select class="form-select form-control-sm page-size-select" id="featuredPageSize" style="width: auto;">
            <option value="12">12 per page</option>
            <option value="24">24 per page</option>
            <option value="36">36 per page</option>
        </select>
    </div>
    <div class="row g-4" id="featuredBooks">
        <div class="text-center py-5 col-12">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading books...</p>
        </div>
    </div>
    <div class="pagination-container">
        <nav aria-label="Featured Books Pagination">
            <ul class="pagination" id="featuredPagination"></ul>
        </nav>
    </div>
</section>

<!-- On Sale Section -->
<section class="container mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>On Sale</h2>
        <select class="form-select form-control-sm page-size-select" id="salePageSize" style="width: auto;">
            <option value="12">12 per page</option>
            <option value="24">24 per page</option>
            <option value="36">36 per page</option>
        </select>
    </div>
    <div class="row g-4" id="saleBooks"></div>
    <div class="pagination-container">
        <nav aria-label="Sale Books Pagination">
            <ul class="pagination" id="salePagination"></ul>
        </nav>
    </div>
</section>

<!-- Footer -->
<footer class="bg-dark text-white py-5">
    <div class="container">
        <div class="row">
            <div class="col-md-4 mb-4 mb-md-0">
                <h5>Kitab Sansar</h5>
                <p>Your one-stop destination for all your reading needs. Discover books from various genres and authors.</p>
            </div>
            <div class="col-md-2 mb-4 mb-md-0">
                <h5>Quick Links</h5>
                <ul class="list-unstyled">
                    <li><a href="#" class="text-white">Home</a></li>
                    <li><a href="#" class="text-white">Books</a></li>
                    <li><a href="#" class="text-white">Categories</a></li>
                    <li><a href="#" class="text-white">About Us</a></li>
                </ul>
            </div>
            <div class="col-md-3 mb-4 mb-md-0">
                <h5>Contact Us</h5>
                <ul class="list-unstyled">
                    <li><i class="bi bi-geo-alt me-2"></i>123 Book Street, Reading City</li>
                    <li><i class="bi bi-envelope me-2"></i>info@kitabsansar.com</li>
                    <li><i class="bi bi-telephone me-2"></i>+1 234 567 8900</li>
                </ul>
            </div>
            <div class="col-md-3">
                <h5>Subscribe</h5>
                <p>Subscribe to our newsletter for updates on new arrivals and special offers.</p>
                <div class="input-group mb-3">
                    <input type="email" class="form-control" placeholder="Your Email">
                    <button class="btn btn-warning" type="button">Subscribe</button>
                </div>
            </div>
        </div>
        <hr>
        <div class="text-center">
            <p class="mb-0">Â© 2023 Kitab Sansar. All rights reserved.</p>
        </div>
    </div>
</footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom JavaScript -->
<script>
    let allBooks = [];
    let paginationState = {
        featured: { currentPage: 1, pageSize: 12 },
        sale: { currentPage: 1, pageSize: 12 }
    };

    document.addEventListener('DOMContentLoaded', function() {
        const user = localStorage.getItem('user');
        if (user) {
            const authButtons = document.querySelector('.d-flex');
            authButtons.innerHTML = `
                <a href="cart.html" class="btn btn-outline-light me-3 position-relative">
                    <i class="bi bi-cart"></i>
                    <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger hidden">0</span>
                </a>
                <a href="bookmarks.html" class="btn btn-outline-light me-3 position-relative">
                    <i class="bi bi-bookmark"></i>
                    <span id="bookmark-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger hidden">0</span>
                </a>
                <div class="dropdown">
                    <button class="btn btn-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle me-1"></i> ${JSON.parse(user).username}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i>Profile</a></li>
                        <li><a class="dropdown-item" href="orders.html"><i class="bi bi-bag me-2"></i>My Orders</a></li>
                        <li><a class="dropdown-item" href="bookmarks.html"><i class="bi bi-bookmark me-2"></i>Wishlist</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </div>
            `;
            updateCartCount();
            updateBookmarkCount();
        }

        loadBooks();

        document.getElementById('searchButton').addEventListener('click', () => {
            paginationState.featured.currentPage = 1;
            paginationState.sale.currentPage = 1;
            updateBooksDisplay();
        });
        document.getElementById('searchInput').addEventListener('input', debounce(() => {
            paginationState.featured.currentPage = 1;
            paginationState.sale.currentPage = 1;
            updateBooksDisplay();
        }, 300));
        document.getElementById('sortSelect').addEventListener('change', () => {
            paginationState.featured.currentPage = 1;
            paginationState.sale.currentPage = 1;
            updateBooksDisplay();
        });
        document.getElementById('clearFilters').addEventListener('click', clearFilters);
        document.getElementById('featuredPageSize').addEventListener('change', (e) => {
            paginationState.featured.pageSize = parseInt(e.target.value);
            paginationState.featured.currentPage = 1;
            updateBooksDisplay();
        });
        document.getElementById('salePageSize').addEventListener('change', (e) => {
            paginationState.sale.pageSize = parseInt(e.target.value);
            paginationState.sale.currentPage = 1;
            updateBooksDisplay();
        });
        document.querySelectorAll('.filter-section input, .filter-section select').forEach(input => {
            input.addEventListener('change', () => {
                paginationState.featured.currentPage = 1;
                paginationState.sale.currentPage = 1;
                updateBooksDisplay();
            });
        });
    });

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    async function loadBooks() {
        try {
            const response = await fetch('/api/book');
            if (!response.ok) throw new Error('Failed to fetch books');
            allBooks = await response.json();
            updateBooksDisplay();
            loadUserBookmarks();
        } catch (error) {
            console.error('Error loading books:', error);
            document.getElementById('featuredBooks').innerHTML = `
                <div class="col-12 text-center text-danger">
                    <i class="bi bi-exclamation-triangle fs-1"></i>
                    <p>Failed to load books. Please try again later.</p>
                </div>
            `;
            document.getElementById('saleBooks').innerHTML = `
                <div class="col-12 text-center text-danger">
                    <p>Failed to load sale books. Please try again later.</p>
                </div>
            `;
        }
    }

    function applyFilters(books) {
        let filteredBooks = [...books];

        const searchQuery = document.getElementById('searchInput').value.trim().toLowerCase();
        if (searchQuery) {
            filteredBooks = filteredBooks.filter(book => 
                (book.title?.toLowerCase().includes(searchQuery) || '') ||
                (book.author?.toLowerCase().includes(searchQuery) || '') ||
                (book.isbn?.toLowerCase().includes(searchQuery) || '')
            );
        }

        const selectedGenres = Array.from(document.querySelectorAll('.filter-section input[id^="genre-"]:checked'))
            .map(input => input.value);
        if (selectedGenres.length > 0) {
            filteredBooks = filteredBooks.filter(book => 
                selectedGenres.includes(book.genre || '')
            );
        }

        const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
        const maxPrice = parseFloat(document.getElementById('maxPrice').value) || Infinity;
        filteredBooks = filteredBooks.filter(book => {
            const price = book.isOnSale && book.discountPrice ? book.discountPrice : book.price;
            return price >= minPrice && price <= maxPrice;
        });

        const minRating = parseFloat(document.getElementById('minRating').value) || 0;
        filteredBooks = filteredBooks.filter(book => (book.rating || 0) >= minRating);

        const selectedFormats = Array.from(document.querySelectorAll('.filter-section input[id^="format-"]:checked'))
            .map(input => input.value);
        if (selectedFormats.length > 0) {
            filteredBooks = filteredBooks.filter(book => 
                selectedFormats.includes(book.format || '')
            );
        }

        const sortOption = document.getElementById('sortSelect').value;
        filteredBooks.sort((a, b) => {
            switch (sortOption) {
                case 'price-asc':
                    return (a.isOnSale && a.discountPrice ? a.discountPrice : a.price) - 
                           (b.isOnSale && b.discountPrice ? b.discountPrice : b.price);
                case 'price-desc':
                    return (b.isOnSale && b.discountPrice ? b.discountPrice : b.price) - 
                           (a.isOnSale && a.discountPrice ? a.discountPrice : a.price);
                case 'rating-desc':
                    return (b.rating || 0) - (a.rating || 0);
                case 'title-asc':
                    return (a.title || '').localeCompare(b.title || '');
                case 'title-desc':
                    return (b.title || '').localeCompare(a.title || '');
                default:
                    return 0;
            }
        });

        return filteredBooks;
    }

    function updateBooksDisplay() {
        const filteredBooks = applyFilters(allBooks);
        const featuredBooksContainer = document.getElementById('featuredBooks');
        const saleBooksContainer = document.getElementById('saleBooks');
        const resultsCount = document.getElementById('resultsCount');

        // Featured Books
        const featuredPageSize = paginationState.featured.pageSize;
        const featuredCurrentPage = paginationState.featured.currentPage;
        const featuredTotalPages = Math.ceil(filteredBooks.length / featuredPageSize);
        const featuredStart = (featuredCurrentPage - 1) * featuredPageSize;
        const featuredEnd = featuredStart + featuredPageSize;
        const featuredBooks = filteredBooks.slice(featuredStart, featuredEnd);

        featuredBooksContainer.innerHTML = '';
        if (filteredBooks.length === 0) {
            featuredBooksContainer.innerHTML = `
                <div class="col-12 text-center">
                    <p>No books match your criteria.</p>
                </div>
            `;
            resultsCount.textContent = `0 books found`;
        } else {
            featuredBooks.forEach(book => {
                const bookCard = createBookCard(book);
                featuredBooksContainer.appendChild(bookCard);
            });
            resultsCount.textContent = `Showing ${featuredStart + 1}-${Math.min(featuredEnd, filteredBooks.length)} of ${filteredBooks.length} books`;
        }

        renderPagination('featured', filteredBooks.length, featuredCurrentPage, featuredPageSize);

        // Sale Books
        const salePageSize = paginationState.sale.pageSize;
        const saleCurrentPage = paginationState.sale.currentPage;
        const saleBooksFiltered = filteredBooks.filter(book => book.isOnSale);
        const saleTotalPages = Math.ceil(saleBooksFiltered.length / salePageSize);
        const saleStart = (saleCurrentPage - 1) * salePageSize;
        const saleEnd = saleStart + salePageSize;
        const saleBooks = saleBooksFiltered.slice(saleStart, saleEnd);

        saleBooksContainer.innerHTML = '';
        if (saleBooksFiltered.length === 0) {
            saleBooksContainer.innerHTML = `
                <div class="col-12 text-center">
                    <p>No books currently on sale match your criteria.</p>
                </div>
            `;
        } else {
            saleBooks.forEach(book => {
                const bookCard = createBookCard(book);
                saleBooksContainer.appendChild(bookCard);
            });
        }

        renderPagination('sale', saleBooksFiltered.length, saleCurrentPage, salePageSize);

        loadUserBookmarks();
    }

    function renderPagination(section, totalItems, currentPage, pageSize) {
        const paginationContainer = document.getElementById(`${section}Pagination`);
        const totalPages = Math.ceil(totalItems / pageSize);
        paginationContainer.innerHTML = '';

        if (totalPages <= 1) return;

        // Previous
        const prevItem = document.createElement('li');
        prevItem.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevItem.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span>&laquo;</span></a>`;
        prevItem.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage > 1) {
                paginationState[section].currentPage--;
                updateBooksDisplay();
            }
        });
        paginationContainer.appendChild(prevItem);

        // Page Numbers (show up to 5 pages, with ellipsis if needed)
        const maxPagesToShow = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        if (startPage > 1) {
            const firstPage = document.createElement('li');
            firstPage.className = 'page-item';
            firstPage.innerHTML = `<a class="page-link" href="#">1</a>`;
            firstPage.addEventListener('click', (e) => {
                e.preventDefault();
                paginationState[section].currentPage = 1;
                updateBooksDisplay();
            });
            paginationContainer.appendChild(firstPage);

            if (startPage > 2) {
                const ellipsis = document.createElement('li');
                ellipsis.className = 'page-item disabled';
                ellipsis.innerHTML = `<span class="page-link">...</span>`;
                paginationContainer.appendChild(ellipsis);
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageItem = document.createElement('li');
            pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageItem.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            pageItem.addEventListener('click', (e) => {
                e.preventDefault();
                paginationState[section].currentPage = i;
                updateBooksDisplay();
            });
            paginationContainer.appendChild(pageItem);
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const ellipsis = document.createElement('li');
                ellipsis.className = 'page-item disabled';
                ellipsis.innerHTML = `<span class="page-link">...</span>`;
                paginationContainer.appendChild(ellipsis);
            }

            const lastPage = document.createElement('li');
            lastPage.className = 'page-item';
            lastPage.innerHTML = `<a class="page-link" href="#">${totalPages}</a>`;
            lastPage.addEventListener('click', (e) => {
                e.preventDefault();
                paginationState[section].currentPage = totalPages;
                updateBooksDisplay();
            });
            paginationContainer.appendChild(lastPage);
        }

        // Next
        const nextItem = document.createElement('li');
        nextItem.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextItem.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span>&raquo;</span></a>`;
        nextItem.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage < totalPages) {
                paginationState[section].currentPage++;
                updateBooksDisplay();
            }
        });
        paginationContainer.appendChild(nextItem);
    }

    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('sortSelect').value = 'none';
        document.getElementById('minPrice').value = '';
        document.getElementById('maxPrice').value = '';
        document.getElementById('minRating').value = '0';
        document.querySelectorAll('.filter-section input[type="checkbox"]').forEach(input => {
            input.checked = false;
        });
        paginationState.featured.currentPage = 1;
        paginationState.sale.currentPage = 1;
        updateBooksDisplay();
    }
    function createBookCard(book) {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-3 mb-4';
    
        const discountAmount = book.isOnSale && book.discountPrice
            ? (book.price - book.discountPrice).toFixed(2)
            : null;
    
        const discountBadge = book.isOnSale && discountAmount > 0
            ? `<div class="discount-badge bg-danger text-white position-absolute top-0 end-0 m-2 px-2 py-1 rounded small">Save $${book.discountPrice.toFixed(2)}</div>`
            : '';
    
        const priceDisplay = book.isOnSale && discountAmount > 0
            ? `<p class="card-text">
                    <span class="text-decoration-line-through text-muted me-2">$${book.price.toFixed(2)}</span>
                    <span class="text-danger fw-bold">$${discountAmount}</span>
               </p>`
            : `<p class="card-text fw-bold">$${book.price.toFixed(2)}</p>`;
    
        col.innerHTML = `
            <div class="card book-card h-100 position-relative">
                ${discountBadge}
                <img src="${book.imageUrl || 'https://via.placeholder.com/300x450?text=No+Image'}" class="card-img-top book-image" alt="${book.title || 'Book'}">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${book.title || 'Untitled'}</h5>
                    <p class="card-text text-muted">by ${book.author || 'Unknown'}</p>
                    <div class="rating-container mb-2">
                        <div class="stars">
                            ${generateStarRating(book.rating)}
                        </div>
                        <small class="text-muted">(${book.numRatings || Math.floor(Math.random() * 500) + 10})</small>
                    </div>
                    ${priceDisplay}
                    <div class="mt-auto d-flex">
                        <button class="btn btn-primary flex-grow-1 me-2" onclick="viewBookDetails(${book.id})">View Details</button>
                        <button class="btn btn-outline-primary action-btn me-2" onclick="addToCart(${book.id}, 1)" title="Add to Cart">
                            <i class="bi bi-cart-plus"></i>
                        </button>
                        <button class="btn btn-outline-primary action-btn bookmark-btn" data-book-id="${book.id}" onclick="addToBookmark(${book.id})" title="Bookmark">
                            <i class="bi bi-bookmark"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    
        return col;
    }
    

    function generateStarRating(rating) {
        const validRating = Math.min(5, Math.max(0, parseFloat(rating) || 0));
        const fullStars = Math.floor(validRating);
        const halfStar = validRating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
        
        let stars = '';
        for (let i = 0; i < fullStars; i++) {
            stars += '<i class="bi bi-star-fill text-warning"></i>';
        }
        if (halfStar) {
            stars += '<i class="bi bi-star-half text-warning"></i>';
        }
        for (let i = 0; i < emptyStars; i++) {
            stars += '<i class="bi bi-star text-warning"></i>';
        }
        return stars;
    }

    function viewBookDetails(bookId) {
        window.location.href = `bookdetails.html?id=${bookId}`;
    }

    function addToBookmark(bookId) { 
        if (!localStorage.getItem('user')) {
            showToast('Please login to bookmark books');
            setTimeout(() => {
                window.location.href = 'Login.html';
            }, 2000);
            return;
        }
        
        fetch(`/api/bookmark/${bookId}`, { 
            method: 'POST', 
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            } 
        }) 
        .then(response => { 
            if (response.ok) { 
                showToast('Book added to your bookmarks!'); 
                updateBookmarkButton(bookId, true); 
                updateBookmarkCount();
            } else { 
                showToast('Failed to add book to bookmarks.'); 
            } 
        }) 
        .catch(error => { 
            console.error('Error:', error); 
            showToast('An error occurred. Please try again.'); 
        }); 
    } 
    
    function removeFromBookmark(bookId) { 
        fetch(`/api/bookmark/${bookId}`, { 
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        }) 
        .then(response => { 
            if (response.ok) { 
                showToast('Book removed from your bookmarks!'); 
                updateBookmarkButton(bookId, false); 
                updateBookmarkCount();
            } else { 
                showToast('Failed to remove book from bookmarks.'); 
            } 
        }) 
        .catch(error => { 
            console.error('Error:', error); 
            showToast('An error occurred. Please try again.'); 
        }); 
    } 
    
    function updateBookmarkButton(bookId, isBookmarked) { 
        const bookmarkBtn = document.querySelector(`.bookmark-btn[data-book-id="${bookId}"]`); 
        if (bookmarkBtn) { 
            if (isBookmarked) { 
                bookmarkBtn.innerHTML = '<i class="bi bi-bookmark-fill"></i>'; 
                bookmarkBtn.classList.add('bookmarked'); 
                bookmarkBtn.onclick = () => removeFromBookmark(bookId); 
            } else { 
                bookmarkBtn.innerHTML = '<i class="bi bi-bookmark"></i>'; 
                bookmarkBtn.classList.remove('bookmarked'); 
                bookmarkBtn.onclick = () => addToBookmark(bookId); 
            } 
        } 
    } 
    
    function loadUserBookmarks() {
        if (!localStorage.getItem('user')) return;
        
        fetch('/api/bookmark', {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        }) 
        .then(response => response.json()) 
        .then(bookmarks => { 
            const bookmarkIds = bookmarks.map(b => b.bookId); 
            document.querySelectorAll('.bookmark-btn').forEach(btn => { 
                const bookId = parseInt(btn.getAttribute('data-book-id')); 
                updateBookmarkButton(bookId, bookmarkIds.includes(bookId)); 
            }); 
        }) 
        .catch(error => { 
            console.error('Error loading bookmarks:', error); 
        }); 
    }
    
    function addToCart(bookId, quantity = 1) {
        if (!localStorage.getItem('user')) {
            showToast('Please login to add books to cart');
            setTimeout(() => {
                window.location.href = 'Login.html';
            }, 2000);
            return;
        }
        
        fetch(`/api/cart/${bookId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify({ quantity: quantity })
        })
        .then(response => {
            if (response.ok) {
                showToast('Book added to your cart!');
                updateCartCount();
            } else {
                showToast('Failed to add book to cart.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred. Please try again.');
        });
    }

    async function updateCartCount() {
        if (!localStorage.getItem('user')) return;
        try {
            const response = await fetch('/api/cart/count', {
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                }
            });
            if (!response.ok) throw new Error('Failed to fetch cart count');
            const data = await response.json();
            const cartCountElement = document.getElementById('cart-count');
            cartCountElement.textContent = data.count;
            cartCountElement.classList.toggle('hidden', data.count === 0);
        } catch (error) {
            console.error('Error updating cart count:', error);
        }
    }

    async function updateBookmarkCount() {
        try {
            let bookmarkCountElement = document.getElementById('bookmark-count');
            if (!bookmarkCountElement) {
                const bookmarkLink = document.querySelector('a[href="bookmarks.html"]');
                if (bookmarkLink) {
                    bookmarkCountElement = document.createElement('span');
                    bookmarkCountElement.id = 'bookmark-count';
                    bookmarkCountElement.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger hidden';
                    bookmarkLink.appendChild(bookmarkCountElement);
                }
            }
    
            if (!bookmarkCountElement) return;
    
            if (localStorage.getItem('user')) {
                const response = await fetch('/api/bookmark', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                if (!response.ok) throw new Error('Failed to fetch bookmarks');
                const bookmarks = await response.json();
                bookmarkCountElement.textContent = bookmarks.length;
                bookmarkCountElement.classList.toggle('hidden', bookmarks.length === 0);
            } else {
                bookmarkCountElement.classList.add('hidden');
            }
        } catch (error) {
            console.error('Error updating bookmark count:', error);
            const bookmarkCountElement = document.getElementById('bookmark-count');
            if (bookmarkCountElement) {
                bookmarkCountElement.classList.add('hidden');
            }
        }
    }

    function showToast(message, duration = 3000) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        toast.offsetHeight;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, duration);
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = 'home.html';
    }
</script>
</body>
</html>